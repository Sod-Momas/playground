<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SockJS test page</title>
  </head>
  <body>
    <input
      type="text"
      name="conn"
      id="conn"
      placeholder="http://localhost:8080/echo"
      value="http://localhost:8080/echo"
    />
    <button onclick="openWs()">连接websocket</button>
    <button onclick="closeWs()">关闭WebSocket连接</button>
    <br />
    <input id="text" type="text" placeholder="请输入内容" />
    <button onclick="send()">发送消息</button>
    <br />
    <input type="file" name="upload" id="upload" />
    <button onclick="upload()">上传文件</button>
    <hr />
    <div id="message"></div>

    <script src="//cdn.jsdelivr.net/sockjs/1.0.0/sockjs.min.js"></script>

    <script>
      //将消息显示在网页上
      function setMessageInnerHTML(innerHTML) {
        var append = document.createElement("div");
        append.innerHTML = innerHTML + "<br/>";
        document.getElementById("message").appendChild(append);
      }
      // 打开连接
      function openWs() {
        sock = new SockJS(
          document.getElementById("conn").value || "http://localhost:8080/echo"
        );
        sock.onopen = function () {
          setMessageInnerHTML("websocket onopen");
        };
        sock.onmessage = function (e) {
          console.log("websocket onmessage:", e);
          setMessageInnerHTML(e.data);
        };
        sock.onclose = function () {
          setMessageInnerHTML("websocket onclose");
        };
        window.sock = sock;
      }
      // 关闭连接
      function closeWs() {
        window.sock.close();
      }
      // 发送消息
      function send() {
        var text = document.getElementById("text").value;
        window.sock.send(text);
      }
      // 上传文件
      function upload() {
        var file = document.getElementById("upload").files[0];
        //    reader.onload = e => {
        //    var ints = new Uint8Array(e.target.result); //要使用读取的内容，所以将读取内容转化成Uint8Array
        //    ints = ints.slice(0, 5000); //截取一段读取的内容
        //    let snippets = new TextDecoder('gb2312').decode(ints); //二进制缓存区内容转化成中文（即也就是读取到的内容）
        //    console.log("读取的内容如下：");
        //    console.log(snippets);
        //     ————————————————
        //     版权声明：本文为CSDN博主「享有盛誉之名」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
        //     原文链接：https://blog.csdn.net/bbs11007/article/details/114521867
        // 未成功
        var reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function (e) {
          console.log("read file onload", e);
          window.sock.send(e.target.result);
        };
      }
    </script>
  </body>
</html>
